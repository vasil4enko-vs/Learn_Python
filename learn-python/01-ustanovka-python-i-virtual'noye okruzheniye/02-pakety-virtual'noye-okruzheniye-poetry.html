<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Poetry - Управление виртуальными средами, пакетами и зависимостями</title>
    </head>
    <body>
        <h1>Создание виртуального окружения, управление пакетами и зависимостями</h1>
        <!-- TODO: Нужно дописать об управлении пакетами и плавно перейти к виртуальным средам -->
        <h2>Виртуальное окружение</h2>
        <p>
            При разработке Python-приложений Вы часто будете использовать в своих проектах не только
            разные версии Python, но и различные версии необходимых Вам библиотек.
        </p>
        <p>К примеру, у Вас есть 2 проекта:</p>
        <ul>
            <li>Проект №1</li>
            <li>Проект №2</li>
        </ul>
        <p>Оба эти проекта используют библиотеку "Библиотека", но разных версий:</p>
        <ul>
            <li>Проект №1 - Библиотека v.1.21</li>
            <li>Проект №2 - Библиотека v.1.25</li>
        </ul>
        <p>
            И тут получается конфликт. Если Вы установите "Библиотеку v.1.21", то "Проект №2" не
            получит необходимую для его работы версию библиотеки - Библиотека v.1.25. Если же Вы
            установите библиотеку с версией 1.25, то она "затрёт" библиотеку версии 1.25. И теперь
            "Проект №1" останется без нужной ему зависимости - "Библиотека v.1.21".
        </p>
        <p>
            Но как и в случае с версиями Python, эта проблема тоже легко решается. И поможет нам в
            этом - виртуальное окружение.
        </p>
        <p>
            <strong>Виртуальное окружение</strong> - это компьютерная система, в которой программа
            или компонент программного обеспечения развёртывается и выполняется. Т.е. своеобразная
            "песочница", для развёртывания и выполнения ПО.
        </p>
        <p>Виртуальное окружение в помогает решить три основные проблемы:</p>
        <ol>
            <li>
                Возможность различным приложениям использовать разные версии одной и той же
                библиотеки.
            </li>
            <li>
                Запрет изменения версий библиотек, используемых приложением. Что позволяет сохранить
                работоспособность приложения после обновления (изменения версий) системных
                библиотек.
            </li>
            <li>
                Предоставление доступа к нужным библиотекам, в случае отсутствия доступа к
                директории <em>/usr/lib/pythonXX/site-packages</em>.
            </li>
        </ol>
        <p>
            Для создания и использования виртуального окружения в Python есть несколько различных
            инструментов, которые мы и рассмотрим далее.
        </p>
        <h2>Инструменты для создания виртуального окружения в Python</h2>
        <p>
            Установив Python Вы сразу получаете и распространяемую с ним Стандартную библиотеку
            Python. А с ней, средство для создания виртуальных сред и работы с ними -
            <em>venv</em>. Но есть и другие утилиты справляющиеся с этими задачами.
        </p>
        <p><strong>Стандартная библиотека Python:</strong></p>
        <ul>
            <li>
                <a href="//docs.python.org/3/library/venv.html"><strong>venv</strong></a> — это
                модуль, поставляемый с Python 3,хотя по какой-то причине некоторые дистрибутивы
                выделяют его в отдельный пакет дистрибутива, например <em>python3-venv</em> в
                Ubuntu/Debian. Модуль venv обеспечивает поддержку создания легковесных виртуальных
                сред с собственным расположением каталогов, при необходимости изолированными от
                системных каталогов. Каждая виртуальная среда имеет свой собственный двоичный файл
                Python (который соответствует версии двоичного файла, который использовался для
                создания этой среды) и может иметь свой собственный независимый набор установленных
                пакетов Python в своих собственных каталогах.
            </li>
            <li>
                <strong>pyvenv</strong> (не путать с <strong>pyenv</strong>) — это скрипт,
                поставляемый раньше с Python 3, но объявленный устаревшим в Python 3.6, поскольку у
                него были проблемы (не говоря уже о запутанном названии). Использовать его не стоит,
                а знать про него - желательно. Мало ли где он может Вам встретиться.
            </li>
        </ul>
        <p><strong>Пакеты не из стандартной библиотеки:</strong></p>
        <ul>
            <li>
                <a href="//virtualenv.pypa.io/en/latest/"><strong>virtualenv</strong></a> - это
                инструмент для создания изолированных сред Python. Начиная с Python 3.3, его
                подмножество было интегрировано в стандартную библиотеку в модуле venv. Модуль venv
                не предлагает всех функций этой библиотеки. Пожалуй наиболее популярная утилита для
                создания виртуальных сред.
            </li>
            <li>
                <a href="//pipenv.pypa.io/"><strong>pipenv</strong></a> - менеджер зависимостей для
                Python-проектов. Он может не только управлять виртуальными средами. С помощью pipenv
                можно создавать виртуальные среды и управлять зависимостями приложений. pipenv
                решает ряд проблем, которые возникали при использовании pip, virtualenv и
                requirements.txt:
                <ul>
                    <li>
                        Вам больше не нужно использовать pip и virtualenv по отдельности. Они
                        работают вместе.
                    </li>
                    <li>
                        Управление зависимостями с использованием файла requirements.txt может быть
                        проблематичным, поэтому pipenv использует два отдельных файла Pipfile и
                        Pipfile.lock для отделения абстрактных объявлений зависимостей от последней
                        проверенной комбинации.
                    </li>
                    <li>
                        Использование хэшей везде и всегда. Безопасность. Автоматическое выявление
                        уязвимостей.
                    </li>
                    <li>
                        Настоятельно рекомендует использовать последние версии зависимостей, чтобы
                        свести к минимуму риски безопасности, связанные с устаревшими компонентами.
                    </li>
                    <li>
                        Даёт Вам представление о зависимостях в графическом виде (например,
                        <em>$ pipenv graph</em>).
                    </li>
                    <li>
                        Позволяет оптимизировать рабочий процесс разработки, используя файлы .env.
                    </li>
                </ul>
            </li>
            <li>
                <a href="//python-poetry.org/"><strong>poetry</strong></a> - менеджер зависимостей,
                позволяющий управлять проектами на Python от начала до конца. Важной особенностью
                рoetry является полное управление библиотеками, заявленными для вашего проекта,
                включая их установку, обновление и публикацию. А также позволяет:
            </li>
            <ul>
                <li>Создавать и упаковывать проекты с помощью одной команды.</li>
                <li>Публиковать проекты в PyPI и приватных репозиториях.</li>
                <li>Проверять состояния зависимостей одной командой.</li>
                <li>Фиксировать версии зависимостей.</li>
                <li>Управлять публикацией билдов.</li>
                <li>
                    Использовать ваши настроенные виртуальные сервера или создавать собственное
                    виртуальное окружение для полной изоляции от вашей системы.
                </li>
            </ul>
        </ul>
        <p>
            Как видите, выбирать есть из чего. И что же выбрать? И тут начинается самое
            интересное...
        </p>
        <p>
            Наверное, лучше всего использовать инструмент из стандартной библиотеки -
            <strong>venv</strong>, но в
            <a
                href="//packaging.python.org/en/latest/tutorials/managing-dependencies/#managing-dependencies"
            >
                документации Python
            </a>
            рекомендуется использовать для управления пакетами<strong>pipenv</strong>, а так как
            pipenv может управлять и виртуальными средами, то как бы env и не нужен. С учётом же
            того, что pipenv использует "под капотом" virtualenv ситуация становится совсем
            запутанной...
        </p>
        <p>
            На эту тему есть
            <a
                href="//stackoverflow.com/questions/41573587/what-is-the-difference-between-venv-pyvenv-pyenv-virtualenv-virtualenvwrappe"
            >
                познавательная дискуссия на Stack Overflow </a
            >.
        </p>
        <p>
            Лично мне, приглянулся <strong>poetry</strong>. Этот инструмент покрывает, практически,
            все запросы по управлению пакетами, позволяет создавать виртуальные окружения и
            управлять ими.
        </p>
        <p>
            Единственно, что он не может, устанавливать нужные версии самого Python, но как Вы уже
            знаете, тут нам поможет <strong>pyenv</strong>.
        </p>
        <p>Если же Вам больше по душе другие инструменты, используйте их. Благо, выбор есть.</p>
        <h2>Poetry</h2>
        <h3>Установка Poetry</h3>
        <p>
            poetry является кросс-платформенным инструментом, его можно использовать в Linux, macOS
            и Windows.
        </p>
        <p>
            Установить poetry можно несколькими способами. В
            <a href="https://python-poetry.org/docs/master/#installation"
                >официальной документации</a
            >
            приводится три варианта установки:
        </p>
        <ul>
            <li>
                с помощью
                <a href="https://install.python-poetry.org"
                    ><strong>официального установщика poetry</strong></a
                >
            </li>
            <li>
                используя
                <a href="https://pypa.github.io/pipx/"><strong>pipx</strong></a> (инструмент для
                установки и запуска приложений Python) в изолированных средах
            </li>
            <li>
                применив по назначению
                <a href="https://pip.pypa.io/en/latest/"><strong>pip</strong></a> (стандартная для
                Python система управления пакетами)
            </li>
        </ul>
        <p>
            Рассмотрим, на мой взгляд, самый рациональный способ - установку poetry при помощи
            <strong>официального установщика</strong>, который позволяет установить poetry
            изолированно от Вашей системы.
        </p>
        <p>Необходимо заметить, что <em>скрипт установки не поддерживает Python < 3.7.</em></p>
        <p>
            Для этого нам потребуется загрузить и выполнить скрипт установки. Делается это одной
            командой в терминале.
        </p>
        <p>Для Linux, macOS, Windows (bashonwindows):</p>
        <pre>
            <code>
$ curl -sSL https://install.python-poetry.org | python3 -
            </code>
        </pre>
        <p>Для Windows (powershell):</p>
        <pre>
            <code>
$ (Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | python -
            </code>
        </pre>
        <p>
            Установщик установит poetry в каталог, расположение которого зависит от вашей системы:
        </p>
        <ul>
            <li>
                Для Linux и macOS:
                <pre><code>$HOME/.local/bin</code></pre>
            </li>
            <li>
                Для Windows:
                <pre><code>%APPDATA%\Python\Scripts</code></pre>
            </li>
        </ul>
        <p>
            Если этого каталога нет в вашем PATH, вам нужно будет добавить его вручную, если вы
            хотите вызывать poetry просто командой <em>poetry</em>, без указания полного пути.
        </p>
        <p>Проверить правильность установки poetry можно командой:</p>
        <pre>
            <code>
$ poetry --version
            </code>
        </pre>
        <p>При правильной установке вывод должен быть схожим с моим:</p>
        <pre>
            <code>
Poetry version 1.1.13
            </code>
        </pre>
        <p>Теперь наш poetry готов к работе.</p>
        <p>Обновить poetry на новую версию можно командой:</p>
        <pre>
            <code>
$ poetry self update
            </code>
        </pre>
        <p>
            Если вы решите, что Poetry вам не подходит, вы можете полностью удалить его из своей
            системы, снова запустив программу установки с параметром <em>--uninstall</em>:
        </p>
        <pre>
            <code>
$ curl -sSL https://install.python-poetry.org | python3 - --uninstall
            </code>
        </pre>
        <p>Или установив переменную среды POETRY_UNINSTALL перед запуском установщика:</p>
        <pre>
            <code>
$ curl -sSL https://install.python-poetry.org | POETRY_UNINSTALL=1 python3 -
            </code>
        </pre>
        <p>
            <strong>poetry</strong> поддерживает создание сценариев завершения для <em>bash</em>,
            <em>fish</em> и <em>zsh</em>.
        </p>
        <p>
            Тем, кто как и я, используют zsh совместно с Oh-My-Zsh нужно будет выполнить в консоли:
        </p>
        <pre>
            <code>
$ mkdir $ZSH_CUSTOM/plugins/poetry
$ poetry completions zsh > $ZSH_CUSTOM/plugins/poetry/_poetry
            </code>
        </pre>
        <p>Возможно, вам придется перезапустить оболочку, чтобы изменения вступили в силу.</p>
        <p>Для oh-my-zsh Вы также должны включить poetry в свои плагинах в файле ~/.zshrc:</p>
        <pre>
            <code>
plugins(
    ...
    poetry
    ...
    )
            </code>
        </pre>
        <p>Всё, poetry готов к работе.</p>
        <p>
            Если же Вы используете другую командную оболочку, то можете обратиться к
            <a
                href="https://python-poetry.org/docs/master/#enable-tab-completion-for-bash-fish-or-zsh"
                >документации poetry</a
            >.
        </p>
        <h3>Работа с Poetry</h3>
    </body>
</html>
